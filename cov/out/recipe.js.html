<!DOCTYPE html>
<html>
<head>
    <style>
        .code {
            white-space: pre;
            font-family: courier new;
            width: 100%;            
        }
        
        .miss {
            background-color: #FF0000;
        }
        
        .hit {
            background-color: #94FF7C;
        }
        
        .undef {
            background-color: #FFFFFF;
        } 

        .nottested {
            background-color: #FFFF00;
        }         
    </style>
</head>
<body>

<div class="code hit">(function(globals, $, head){</div>
<div class="code undef"></div>
<div class="code hit">  var base = '',</div>
<div class="code undef">      method = '',</div>
<div class="code undef">      cache = {},</div>
<div class="code undef">      dfd = {</div>
<div class="code undef">        version: new $.Deferred(),</div>
<div class="code undef">        dependencies: new $.Deferred()</div>
<div class="code undef">      },</div>
<div class="code undef">      uniq = function(array){</div>
<div class="code hit">        var i,</div>
<div class="code undef">            len,</div>
<div class="code undef">            uniqued = [];</div>
<div class="code hit">        for(i = 0, len = array.length; i &lt; len; i++){</div>
<div class="code hit">          if( $.inArray(array[i], uniqued) === -1 ){</div>
<div class="code hit">            uniqued.push(array[i]);</div>
<div class="code undef">          }</div>
<div class="code undef">        }</div>
<div class="code hit">        return uniqued;</div>
<div class="code undef">      },</div>
<div class="code undef">      recipe = function(options){</div>
<div class="code hit">        var namespace,</div>
<div class="code undef">            libraries = (options||{}).libraries||[],</div>
<div class="code undef">            scripts = (options||{}).scripts||[],</div>
<div class="code undef">            dependencies = recipe.dependencies,</div>
<div class="code undef">            urls = [],</div>
<div class="code undef">            args = [],</div>
<div class="code undef">            dfd = new $.Deferred(),</div>
<div class="code undef">            len,</div>
<div class="code undef">            deps,</div>
<div class="code undef">            set,</div>
<div class="code undef">            i;</div>
<div class="code undef"></div>
<div class="code hit">        for( i = 0, len = libraries.length; i&lt;len; i++){</div>
<div class="code hit">          deps = dependencies[libraries[i]];</div>
<div class="code hit">          if(!deps) {</div>
<div class="code hit">            dfd.reject("Ingredients not found. namespace["+libraries[i]+"]");</div>
<div class="code hit">            return dfd;</div>
<div class="code undef">          }</div>
<div class="code hit">          urls = urls.concat( deps );</div>
<div class="code undef">        }</div>
<div class="code undef"></div>
<div class="code hit">        urls = uniq( urls.concat(scripts) );</div>
<div class="code hit">        for( i = 0, len = urls.length; i&lt;len; i++){</div>
<div class="code hit">          set = urls[i].split("#");</div>
<div class="code hit">          if(!set[0]){</div>
<div class="code hit">            dfd.reject("Illegal URL were exists. [\""+urls.join("\", \"")+"\"]");</div>
<div class="code hit">            return dfd;</div>
<div class="code undef">          }</div>
<div class="code hit">          args.push(set[0]+"?_="+recipe.version+(set[1]?"#"+set[1]:""));</div>
<div class="code undef">        }</div>
<div class="code undef"></div>
<div class="code hit">        if(args.length) {</div>
<div class="code hit">          args.push(function(){</div>
<div class="code hit">            dfd.resolve();</div>
<div class="code undef">          });</div>
<div class="code hit">          head.js.apply(head, args);</div>
<div class="code undef">        } else {</div>
<div class="code hit">          dfd.resolve();</div>
<div class="code undef">        }</div>
<div class="code hit">        return dfd;</div>
<div class="code undef">      },</div>
<div class="code undef">      methods = {</div>
<div class="code undef">        init: function(){</div>
<div class="code hit">          var script = $("script[src$='/recipe.js'][data-menu]"),</div>
<div class="code undef">              url = script.data("menu")||"";</div>
<div class="code undef">          </div>
<div class="code hit">          base = url.replace(/[^\/]+$/, '');</div>
<div class="code hit">          if(!url) {</div>
<div class="code hit">            throw new ReferenceError("You might forget to order because of menu was not founded.");</div>
<div class="code undef">          }</div>
<div class="code hit">          recipe.get.version().then(function(){</div>
<div class="code hit">            recipe.get.dependencies().then(function(){</div>
<div class="code hit">              recipe.resolve(url);</div>
<div class="code undef">            });</div>
<div class="code undef">          });</div>
<div class="code undef"></div>
<div class="code undef">        },</div>
<div class="code undef">        resolve: function(url){</div>
<div class="code hit">          var set = url.split("#");</div>
<div class="code hit">          head.js(set[0]+"?_="+recipe.version+(set[1]?"#"+set[1]:""));</div>
<div class="code undef">        },</div>
<div class="code undef">        get: {</div>
<div class="code undef">          version: function(){</div>
<div class="code hit">            if( !recipe.version ) {</div>
<div class="code hit">              head.js(base+'/recipe.version.js?_='+(new Date().getTime()), function(){</div>
<div class="code hit">                dfd.version.resolve(recipe.version);</div>
<div class="code undef">              });</div>
<div class="code undef">            } else {</div>
<div class="code hit">              dfd.version.resolve(recipe.version);</div>
<div class="code undef">            }</div>
<div class="code hit">            return dfd.version;</div>
<div class="code undef">          },</div>
<div class="code undef">          dependencies: function(){</div>
<div class="code hit">            if(!recipe.dependencies) {</div>
<div class="code hit">              head.js(base+'/recipe.dependencies.js?_='+recipe.version, function(){</div>
<div class="code hit">                dfd.dependencies.resolve(recipe.dependencies);</div>
<div class="code undef">              });</div>
<div class="code undef">            } else {</div>
<div class="code hit">              dfd.dependencies.resolve(recipe.dependencies);</div>
<div class="code undef">            }</div>
<div class="code hit">            return dfd.dependencies;</div>
<div class="code undef">          }</div>
<div class="code undef">        }</div>
<div class="code undef">      };</div>
<div class="code undef"></div>
<div class="code hit">  for(method in methods){</div>
<div class="code hit">    recipe[method] = methods[method];</div>
<div class="code undef">  }</div>
<div class="code undef"></div>
<div class="code hit">  globals.recipe = recipe;</div>
<div class="code hit">  recipe.init();</div>
<div class="code undef">})(this, jQuery, head);</div>


</body>
</html>
